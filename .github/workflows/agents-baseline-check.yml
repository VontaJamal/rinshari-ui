name: Agents Baseline Check

on:
  pull_request:
  push:
    branches:
      - main
      - master

permissions:
  contents: read

jobs:
  verify-agents-baseline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate CORE-DOCTRINE baseline
        shell: bash
        run: |
          set -euo pipefail

          target="AGENTS.md"
          [[ -f "$target" ]] || { echo "AGENTS.md missing" >&2; exit 1; }

          start='<!-- CORE-DOCTRINE:START -->'
          end='<!-- CORE-DOCTRINE:END -->'

          marker_count="$(grep -Ec '<!-- CORE-DOCTRINE:(START|END) -->' "$target")"
          [[ "$marker_count" -eq 2 ]] || { echo "AGENTS.md must contain exactly one CORE-DOCTRINE block" >&2; exit 1; }

          block="$(awk -v s="$start" -v e="$end" '
            BEGIN { capture=0 }
            {
              if (index($0, s)) { capture=1; print; next }
              if (capture) print
              if (index($0, e)) { exit }
            }
          ' "$target")"

          [[ -n "$block" ]] || { echo "CORE-DOCTRINE block is empty" >&2; exit 1; }

          for required in \
            "## Command Doctrine (Solo Leveling Model)" \
            "### Protagonist Commander" \
            "The Seven Saints" \
            "AI is a force multiplier under command discipline, not a substitute for judgment." \
            "Saint of Aesthetics" \
            "Saint of Security" \
            "Saint of Accessibility" \
            "Saint of Testing" \
            "Saint of Execution" \
            "Saint of Scales" \
            "Saint of Value" \
            "Script (AI Laws):" \
            "No raw secrets, credentials, or sensitive user data to external AI systems." \
            "TypeScript is the default language for all new implementation work" \
            "TypeScript strict mode is mandatory" \
            "is allowed only at uncontrolled external boundaries and must be narrowed immediately." \
            "Zod is required for TypeScript runtime validation" \
            "Python is a pre-approved exception and must use Pydantic" \
            "Any non-TypeScript/non-Python language requires explicit owner-approved exception." \
            "Language Exception Record" \
            "codex/*" \
            "feature-branch git tree clean before running verification/testing" \
            "never declare completion while the active feature branch is dirty" \
            "behavior-first tests" \
            "hourly/nightly" \
            "weekly/monthly/quarterly"; do
            printf '%s\n' "$block" | grep -Fq "$required" || {
              echo "CORE-DOCTRINE block missing required text: $required" >&2
              exit 1
            }
          done
